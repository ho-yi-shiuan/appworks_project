<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link rel=stylesheet type="text/css" href="./socket.css">
</head>
<body>
<span style="font-family:Microsoft JhengHei;">
<div class = "body">
	<div class = "profile_map">
		<div class = "profile">
			<div class = "picture"></div>
			<div class = "information"></div>
		</div>
		<div class = "map_mark">
			<div id="map"></div>
			<div class = "mark">
				<b style="font-size:20px">←最近出沒地點</b></br>
				<img src="/images/placeholder.png"> : 走失地點</br>
				<img src="/images/pin.png"> : 回報出現地點(點擊標記可觀看回報相關資訊)</br></br>
				<b style="font-size:16px">若發現該寵物出現, 請在以下回報地點</b></br>
				請輸入地址: </br><input type="text" id="insert_mark" placeholder = "ex: 臺北市信義區信義路五段7號"></input>
				<button id="select_current_spot">存取目前位置</button></br>
				請輸入發現時間等其他資訊: </br><textarea id="insert_info" type = "textarea" placeholder = "ex: 1/10上午10點發現, 與其他流浪犬集體出現" style="width:250px;height:50px;"></textarea></br>			
				<button id="submit_mark">送出</button>
				</form>
			</div>
		</div>
	</div>
	<div class = "chatroom">
		<div class="chats">
		</div>
		<div class="message">
			<input id="content" type="text" placeholder="input the message" />
			<button id="submit_message" type="button">送出</button>
			<input type="file" id="socket_picture">
			<button id="submit_picture" type="button">上傳</button>
		</div>
	</div>
<script src='https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/locale/zh-tw.js'></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script>
	//google map code start
	console.log("開始執行map script");
	var map;
	function initMap() {
		console.log("執行init map");
		geocoder = new google.maps.Geocoder();
		map = new google.maps.Map(document.getElementById('map'), {
			zoom: 15
		});
	}
	//googlt map code end	
	
	//進入頁面需先輸入名稱 start
	var user_name = prompt("請輸入姓名");
	//進入頁面需先輸入名稱 end
	
	//socket code start
	console.log("開始執行socket script");
	socket = io.connect();
	socket.on('connect', function () {
		socket.emit('join', user_name);
	});
	document.getElementById("submit_message").addEventListener('click', function(){
		Send();
	});
	function Send() {
		let content = document.querySelector('#content').value;
		if (!content && !name) {
			alert('請輸入訊息');
			return;
		}
		let data = {
			name: user_name,
			content: content,
		};
		//傳訊息給後端
		console.log(data);
		socket.emit('message', data);
		document.querySelector('#content').value = '';
	}
	//傳送圖片檔
	document.getElementById("submit_picture").addEventListener('click', function(){
		sendPicture();
	});
	
	function sendPicture(){
		let Imginput = document.getElementById('socket_picture');
		let file = Imginput.files[0];
		let reader = new FileReader();
		reader.readAsDataURL(file);
		reader.onload =function(){
			let data = {
				name: user_name,
				img: {img: this.result}
			};
			//let data = {img: this.result};
			socket.emit('sendImg', data);
		}	
	}
	//收到後端傳來的圖片處理
	socket.on('receiveImg', (obj) => {
		console.log(obj);
		appendImage(obj);
	})
	
	function appendImage(obj){		
		var chat = document.createElement("div");
		chat.className = "chat";
		var group = document.createElement("div");
		group.className = "group";
		var name = document.createElement("div");
		name.className = "name";
		var element_name = document.createTextNode(obj.name);
		var chat_picture = document.createElement("img");
		chat_picture.className = "chat_picture_file";
		chat_picture.src = obj.img.img;
		var time = document.createElement("div");
		time.className = "time";
		var element_time = document.createTextNode(moment(obj.time).fromNow());
		time.appendChild(element_time);
		name.appendChild(element_name);
		group.appendChild(name);
		group.appendChild(chat_picture);
		chat.appendChild(group);
		chat.appendChild(time);
		document.getElementsByClassName("chats")[0].appendChild(chat);
		scrollWindow();
	}
	//顯示歷史訊息
	socket.on('history', function(obj){
		console.log("收到後端歷史訊息");
		if (obj.length > 0) {
			appendData(obj);
		}
	});

	//收到後端傳來的訊息如何處理
	socket.on('message', (obj) => {
		console.log(obj);
		appendData([obj]);
	});

	function appendData(obj){
		obj.forEach(function(element){
			var chat = document.createElement("div");
			chat.className = "chat";
			var group = document.createElement("div");
			group.className = "group";
			var name = document.createElement("div");
			name.className = "name";
			var content = document.createElement("div");
			content.className = "content";
			var element_name = document.createTextNode(element.name);
			var element_content = document.createTextNode(element.content);
			var time = document.createElement("div");
			time.className = "time";
			var element_time = document.createTextNode(moment(element.time).fromNow());
			time.appendChild(element_time);
			name.appendChild(element_name);
			content.appendChild(element_content);
			group.appendChild(name);
			group.appendChild(content);
			chat.appendChild(group);
			chat.appendChild(time);
			document.getElementsByClassName("chats")[0].appendChild(chat);
		});
		scrollWindow();
	}

	function scrollWindow(){
		let h = document.querySelector('.chats');//回傳第一個找到的class
		h.scrollTo(0, h.scrollHeight);
	}
	//socket code end
	//ajax code start
	let urlParams = new URLSearchParams(window.location.search);
	let id = urlParams.get('id')
	const xhr = new XMLHttpRequest();
	var url = "/lost_detail?id="+id;
	xhr.open("get", url);
	xhr.onload = function(){
		var detail = JSON.parse(this.response);
		var picture_file = document.createElement("img");
		picture_file.className = "picture_file";
		picture_file.src = detail.picture;
		document.getElementsByClassName("picture")[0].appendChild(picture_file);
		var name = document.createElement("name");
		name.className = "name";
		var pet_name = document.createTextNode("姓名: "+detail.name);
		name.appendChild(pet_name);
		document.getElementsByClassName("information")[0].appendChild(name);
		var gender = document.createElement("div");
		gender.className = "gender";
		var pet_gender = document.createTextNode("性別: "+detail.gender);
		gender.appendChild(pet_gender);
		document.getElementsByClassName("information")[0].appendChild(gender);
		var age = document.createElement("div");
		age.className = "age";
		var pet_age = document.createTextNode("年齡: "+detail.age);
		age.appendChild(pet_age);
		document.getElementsByClassName("information")[0].appendChild(age);
		var breed = document.createElement("div");
		breed.className = "breed";
		var pet_breed = document.createTextNode("品種: "+detail.breed);
		breed.appendChild(pet_breed);
		document.getElementsByClassName("information")[0].appendChild(breed);
		var color = document.createElement("div");
		color.className = "color";
		var pet_color = document.createTextNode("顏色: "+detail.color);
		color.appendChild(pet_color);
		document.getElementsByClassName("information")[0].appendChild(color);
		var lost_location = document.createElement("div");
		lost_location.className = "lost_location";
		var pet_lost_location = document.createTextNode("走失地點: "+detail.lost_location);
		lost_location.appendChild(pet_lost_location);
		document.getElementsByClassName("information")[0].appendChild(lost_location);
		var lost_time = document.createElement("div");
		lost_time.className = "lost_time";
		var pet_lost_time = document.createTextNode("走失時間: "+detail.lost_time);
		lost_time.appendChild(pet_lost_time);
		document.getElementsByClassName("information")[0].appendChild(lost_time);
		var other = document.createElement("div");
		other.className = "other";
		var pet_other = document.createTextNode("其他: "+detail.other);
		other.appendChild(pet_other);
		document.getElementsByClassName("information")[0].appendChild(other);
		//google map mark(db current mark) code start
		var address = detail.lost_location;
		geocoder.geocode( { 'address': address}, function(results, status) {
			if (status == 'OK') {
				map.setCenter(results[0].geometry.location);
				var marker = new google.maps.Marker({
					map: map,
					position: results[0].geometry.location,//new google.maps.LatLng(22.991965, 120.202518),
					icon: '/images/placeholder.png'
				});
				var infowindow = new google.maps.InfoWindow({
					content: "走失地"
				});
				infowindow.open(map, marker);
			} else {
				console.log("地址轉換成經緯度: "+status);
			}
		});
		for(i=0; i<detail.markers.length; i++){
			let infowindow_content = detail.markers[i].marker_description;
			geocoder.geocode( { 'address': detail.markers[i].marker_location}, function(results, status) {
				if (status == 'OK') {
					var marker = new google.maps.Marker({
						map: map,
						position: results[0].geometry.location,//new google.maps.LatLng(22.991965, 120.202518),
						icon: '/images/pin.png'
					});
					var infowindow = new google.maps.InfoWindow({
						content: infowindow_content
					});
					marker.addListener('click', function() {
						infowindow.open(map, marker);
					});
				} else {
					console.log("地址轉換成經緯度: "+status);
				}
			});
		}
		//google map mark(db current mark) code end
	}
	xhr.send();
	//ajax code end
	//存取目前位置code start
	document.getElementById("select_current_spot").addEventListener('click', function(){
		get_spot();
	});
	function get_spot(){
		navigator.geolocation.getCurrentPosition(function(position) {
			var pos = position.coords.latitude+", "+position.coords.longitude;
			console.log(pos);
			document.getElementById("insert_mark").value = pos;
		});
	}
	//存取目前位置code end
	//ajax send mark code start
	document.getElementById("submit_mark").addEventListener('click', function(){
		insert_mark();
	});
	function insert_mark(){
		var new_mark = {
			insert_mark:document.getElementById("insert_mark").value,
			insert_info:document.getElementById("insert_info").value
		}
		$.ajax({
			contentType :"application/json",
			type: "POST",
			url: "/lost_mark",
			data: JSON.stringify(new_mark),
			success: function(res)
				{
					document.getElementById("insert_mark").value = "";
					insert_info:document.getElementById("insert_info").value = "";
					geocoder.geocode( { 'address': res.location}, function(results, status) {
						if (status == 'OK') {
							var marker = new google.maps.Marker({
								map: map,
								position: results[0].geometry.location,//new google.maps.LatLng(22.991965, 120.202518),
								icon: '/images/pin.png'
							});
							var infowindow = new google.maps.InfoWindow({
								content: res.description
							});
							marker.addListener('click', function() {
								infowindow.open(map, marker);
							});
						} else {
							console.log("地址轉換成經緯度: "+status);
						}
					});
				},
			dataType: "json"
			});
	}
	//ajax send mark code end
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBqPLiFTzh0Hn0piEvo_AGElKvHPlHO7SM&callback=initMap"></script>
</body>
</html>